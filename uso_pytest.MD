üß™ Guia Definitivo de Uso do Pytest em Python

Autor: Reinaldo

Vers√£o: 2.0 (Atualizada para 2025)

Frameworks abordados: pytest, pytest-xdist, pytest-playwright, pytest-mock

## 1. üìò O que √© o Pytest?

O pytest √© um dos frameworks de teste mais populares e poderosos do ecossistema Python.

Ele oferece uma forma simples, declarativa e Pythonic de escrever testes ‚Äî desde unit√°rios at√© testes de integra√ß√£o e fim a fim.

**Principais vantagens:**
*   **Sintaxe Simples:** voc√™ escreve `assert` como no Python puro.
*   **Descoberta Autom√°tica:** pytest encontra os testes automaticamente.
*   **Fixtures:** permitem gerenciar depend√™ncias e estados de teste.
*   **Ecosistema de Plugins:** integra√ß√£o com Django, FastAPI, Playwright, cobertura de c√≥digo, mocks, paraleliza√ß√£o e muito mais.
*   **Excelente Relat√≥rio de Falhas:** mensagens ricas e f√°ceis de ler.

## 2. ‚öôÔ∏è Instala√ß√£o

√â sempre recomendado o uso de um ambiente virtual.

````bash
pip install pytest
````

Plugins √∫teis:
````bash
pip install pytest-mock pytest-cov pytest-xdist pytest-playwright
````

## 3. üßÆ Escrevendo o primeiro teste
C√≥digo a ser testado ‚Äî calculadora.py
```python
def somar(a, b):
    """Soma dois n√∫meros."""
    return a + b

def subtrair(a, b):
    """Subtrai dois n√∫meros."""
    return a - b
```

Arquivo de teste ‚Äî test_calculadora.py
```python
from calculadora import somar, subtrair

def test_somar():
    """Testa a fun√ß√£o somar com n√∫meros positivos."""
    assert somar(2, 3) == 5
    assert somar(10, 10) == 20

def test_subtrair():
    """Testa a subtra√ß√£o simples."""
    assert subtrair(10, 5) == 5
```

Executar:
````bash
pytest -v
````

## 4. ‚ö° Fixtures ‚Äì Inje√ß√£o de Depend√™ncias Reutiliz√°veis

Fixtures s√£o fun√ß√µes que preparam um contexto (dados, conex√µes, objetos) e o injetam nos testes automaticamente.

Fixture simples ‚Äî test_dados.py
```python
import pytest

@pytest.fixture
def dados_iniciais():
    """Fixture que retorna um dicion√°rio de exemplo."""
    print("\n(SETUP) Criando dicion√°rio...")
    return {"nome": "Ana", "idade": 30}

def test_verificar_nome(dados_iniciais):
    assert dados_iniciais["nome"] == "Ana"

def test_verificar_idade(dados_iniciais):
    assert isinstance(dados_iniciais["idade"], int)
```


Execute com:

````bash
pytest -s
````

## 5. üîÑ Fixtures com Setup e Teardown

Use yield dentro da fixture para executar c√≥digo antes e depois dos testes (setup/teardown).

```python
@pytest.fixture
def cliente_db():
    print("\n(SETUP) Conectando ao banco de dados...")
    db = conectar_ao_db()
    yield db
    print("\n(TEARDOWN) Desconectando do banco de dados...")
    db.desconectar()
```

## 6. üè∑Ô∏è Marcadores e Agrupamentos

Marcadores permitem categorizar e filtrar testes.

```python
import pytest
import time, sys

@pytest.mark.smoke
def test_funcionalidade_essencial():
    assert True

@pytest.mark.slow
def test_funcionalidade_lenta():
    time.sleep(2)
    assert True

@pytest.mark.skip(reason="Ainda n√£o implementado")
def test_funcionalidade_futura():
    assert False

@pytest.mark.skipif(sys.version_info < (3, 10), reason="Requer Python 3.10+")
def test_python10():
    assert True

@pytest.mark.xfail(reason="Bug conhecido #123")
def test_com_bug():
    assert 1 == 2

### Marcadores Espec√≠ficos do Playwright

O `pytest-playwright` fornece marcadores especiais para controlar a execu√ß√£o de testes com base no navegador.

```python
import pytest
from playwright.sync_api import Page

@pytest.mark.skip_browser("firefox")
def test_funcionalidade_nao_suportada_no_firefox(page: Page):
    """
    Este teste ser√° pulado se estiver sendo executado no Firefox.
    Ser√° executado em Chromium e WebKit.
    """
    page.goto("https://example.com")
    assert "Example" in page.title()

@pytest.mark.only_browser("chromium")
def test_funcionalidade_apenas_no_chromium(page: Page):
    """
    Este teste ser√° executado APENAS no Chromium.
    Ser√° pulado em Firefox e WebKit.
    """
    page.goto("https://example.com")
    assert "Example" in page.title()
```

## 7. üöÄ Testes em Paralelo com pytest-xdist

Para projetos grandes, paralelize:

````bash
pytest -n 4
````

Ou use todos os n√∫cleos dispon√≠veis:

````bash
pytest -n auto
````

## 8. üîÄ Parametriza√ß√£o de Testes
```python
import pytest
from calculadora import somar

@pytest.mark.parametrize("a,b,resultado", [
    (2, 3, 5),
    (-1, 1, 0),
    (10, 10, 20),
])
def test_somar_varios(a, b, resultado):
    assert somar(a, b) == resultado
```

## 9. ‚ùå Testando Exce√ß√µes
```python
import pytest

def dividir(a, b):
    if b == 0:
        raise ValueError("Divis√£o por zero n√£o permitida")
    return a / b

def test_divisao_erro():
    with pytest.raises(ValueError, match="Divis√£o por zero"):
        dividir(1, 0)
```

## 10. üîß Configura√ß√£o com pytest.ini
VS Code
(rerun without)
### O arquivo pytest.ini √© um arquivo de configura√ß√£o que permite definir op√ß√µes padr√£o para o pytest, evitando a necessidade de digit√°-las repetidamente na linha de comando.

[pytest]: Esta √© a se√ß√£o principal que cont√©m todas as configura√ß√µes do pytest.
markers: Registra marcadores personalizados. Isso evita erros de digita√ß√£o e permite que o pytest saiba quais marcadores s√£o intencionais. No exemplo, smoke, slow e api s√£o registrados com suas descri√ß√µes.

testpaths: Especifica os diret√≥rios onde o pytest deve procurar por testes. No exemplo, os testes ser√£o procurados apenas na pasta tests.

python_files: Define os padr√µes de nome de arquivo que o pytest considerar√° como arquivos de teste. No exemplo, arquivos que come√ßam com test_ ou terminam com _test ser√£o coletados.

addopts: Adiciona op√ß√µes de linha de comando que ser√£o executadas por padr√£o em cada execu√ß√£o do pytest. As op√ß√µes do Playwright s√£o configuradas aqui:
--browser: Especifica em qual navegador (ou navegadores) os testes devem ser executados. Voc√™ pode listar chromium, firefox e webkit.
--screenshot only-on-failure: Captura uma imagem da tela automaticamente, mas a salva apenas se o teste falhar.
--video retain-on-failure: Grava um v√≠deo da execu√ß√£o do teste e o mant√©m somente se o teste falhar.
--tracing on: Habilita o rastreamento do Playwright, que gera um arquivo de rastreio detalhado para depura√ß√£o p√≥s-execu√ß√£o.
--numprocesses 4: Op√ß√£o do pytest-xdist que executa os testes em paralelo usando 4 processos, acelerando a execu√ß√£o.

```ini
# filepath: pytest.ini
[pytest]
markers =
    smoke: Testes essenciais de valida√ß√£o
    slow: Testes lentos
    api: Testes de API
addopts = 
    --browser chromium
    --browser firefox
    --browser webkit
    --screenshot only-on-failure
    --video retain-on-failure
    --tracing on
    --numprocesses 4
testpaths = tests
python_files = test_*.py *_test.py
```

## 11. üìà Relat√≥rio de Cobertura de C√≥digo
````bash
pytest --cov=calculadora --cov-report=term-missing --cov-report=html
````


Gera um relat√≥rio no console e um HTML em htmlcov/index.html.

## 12. üß© Integrando Pytest com Playwright

O plugin pytest-playwright permite automatizar navegadores (Chromium, Firefox, WebKit) facilmente.

Instala√ß√£o:
````bash
pip install pytest-playwright
playwright install
````

Exemplo de Fixture com Page:
```python
# filepath: tests/test_google.py
def test_titulo_google(page):
    """Verifica o t√≠tulo da p√°gina principal do Google."""
    page.goto("https://www.google.com")
    assert "Google" in page.title()
```

Fixture personalizada para login automatizado:
```python
import pytest

@pytest.fixture(scope="session")
def pagina_logada(browser):
    """Abre o navegador, faz login e retorna p√°gina autenticada."""
    context = browser.new_context()
    page = context.new_page()
    page.goto("https://meusistema.com/login")
    page.fill("#usuario", "admin")
    page.fill("#senha", "123456")
    page.click("#entrar")
    page.wait_for_selector("#dashboard")
    yield page
    context.close()

def test_dashboard_acesso(pagina_logada):
    """Verifica se a p√°gina do dashboard carrega corretamente."""
    assert "Dashboard" in pagina_logada.title()
```

## 13. üåê Mockando Requisi√ß√µes com Pytest + Requests + pytest-mock

Usar o plugin pytest-mock simplifica o uso de mocks, sem precisar do unittest.mock manualmente.

Exemplo ‚Äî Mockando uma requisi√ß√£o com requests.get
```python
import pytest
import requests

def buscar_usuario():
    resposta = requests.get("https://api.example.com/users/1")
    return resposta.json()

def test_buscar_usuario_mockado(mocker):
    """Mocka a fun√ß√£o requests.get para simular uma API externa."""
    mock_response = mocker.Mock()
    mock_response.json.return_value = {"id": 1, "nome": "Reinaldo"}
    mocker.patch("requests.get", return_value=mock_response)

    resultado = buscar_usuario()
    assert resultado["nome"] == "Reinaldo"
```

Mockando Requisi√ß√£o dentro do Playwright:
```python
def test_mock_request(page):
    """Simula a resposta de uma API dentro do navegador."""
    page.route("**/api/dados", lambda route: route.fulfill(
        status=200,
        content_type="application/json",
        body='{"usuario":"mockado","status":"ok"}'
    ))

    page.goto("https://meusistema.com/dashboard")
    response = page.evaluate("fetch('/api/dados').then(r => r.json())")
    assert response["usuario"] == "mockado"
```

## 14. ‚è±Ô∏è Dicas Avan√ßadas de Uso Di√°rio
*   `pytest -s` ‚Üí mostra `print()` no terminal
*   `pytest -x` ‚Üí para no primeiro erro
*   `pytest --lf` ‚Üí roda apenas os √∫ltimos testes que falharam
*   `pytest -v -m "smoke and not slow"` ‚Üí filtros de marcadores compostos
*   `pytest tests/nome_do_arquivo_de_teste.py` ‚Üí roda todos os testes em um arquivo espec√≠fico

## 15. üí° Boas Pr√°ticas
*   Cada teste deve isolar comportamento independente.
*   Nomeie claramente os testes com verbos: `test_calcula_media`, `test_login_sucesso`, etc.
*   Use fixtures reutiliz√°veis em `conftest.py` (escopos: function, class, module, session).
*   Sempre use `pytest-cov` em pipelines CI/CD para medir cobertura.
*   Evite chamadas reais de rede; prefira mockar requisi√ß√µes (consist√™ncia + performance).

## 16. üåç Estrutura de Projeto Recomendada
```plaintext
/automation_playwright_python
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ calculadora.py
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py        # Fixtures globais
‚îÇ   ‚îú‚îÄ‚îÄ test_calculadora.py
‚îÇ   ‚îú‚îÄ‚îÄ test_api_mock.py
‚îÇ   ‚îî‚îÄ‚îÄ test_ui_login.py
‚îú‚îÄ‚îÄ pytest.ini
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md
```

## 17. üî¨ Exemplos de fixtures com todos os escopos (Playwright) ‚Äî explicado

Abaixo h√° exemplos de fixtures usando pytest-playwright cobrindo todos os escopos suportados pelo pytest: function (padr√£o), class, module, package e session. Cada exemplo mostra como criar contextos/p√°ginas e quando usar cada escopo.

Importante: pytest-playwright j√° fornece fixtures √∫teis como `browser` e `page` (o `page` √© function-scoped por padr√£o). Nos exemplos abaixo usamos a fixture `browser` para criar contextos e p√°ginas manualmente.

### Escopo: function (padr√£o)
Isolamento m√°ximo ‚Äî cria contexto/p√°gina para cada teste. Recomendada para maior independ√™ncia entre testes.
```python
import pytest

def test_function_scope(page):  # usa o page fornecido pelo pytest-playwright
    page.goto("https://example.com")
    assert "Example" in page.title()
```

### Escopo: class
Reusa a mesma p√°gina/contexto para todos os testes de uma classe. √ötil quando m√∫ltiplos testes dentro da classe podem compartilhar estado ou setup custoso.
```python
import pytest

@pytest.fixture(scope="class")
def class_page(browser):
    context = browser.new_context()
    page = context.new_page()
    yield page
    context.close()

class TestClassScope:
    def test_a(self, class_page):
        class_page.goto("https://example.com/a")
        assert "Example" in class_page.title()

    def test_b(self, class_page):
        class_page.goto("https://example.com/b")
        assert "Example" in class_page.title()
```

### Escopo: module
Cria uma p√°gina/contexto para todos os testes dentro de um m√≥dulo (arquivo .py). Boa op√ß√£o quando v√°rios testes do mesmo m√≥dulo compartilham setup.
```python
import pytest

@pytest.fixture(scope="module")
def module_page(browser):
    ctx = browser.new_context()
    page = ctx.new_page()
    yield page
    ctx.close()

def test_module_1(module_page):
    module_page.goto("https://example.com/1")
    assert module_page.url.endswith("/1")

def test_module_2(module_page):
    module_page.goto("https://example.com/2")
    assert module_page.url.endswith("/2")
```

### Escopo: package
Reusa o mesmo contexto/p√°gina para todos os testes em um pacote (diret√≥rio com __init__.py). √ötil para suites grandes organizadas por pacotes.
Observa√ß√£o: o `scope="package"` tem efeito quando os testes est√£o dentro de um pacote Python.
```python
import pytest

@pytest.fixture(scope="package")
def package_context(browser):
    ctx = browser.new_context()
    yield ctx
    ctx.close()

# Em testes dentro do mesmo package, use package_context para criar p√°ginas:
def test_in_package(page_factory, package_context):
    page = package_context.new_page()
    page.goto("https://example.com/package")
    assert "Example" in page.title()
    page.close()
```

### Escopo: session
Cria o recurso uma vez por sess√£o de testes (toda execu√ß√£o do pytest). M√°xima economia de tempo, por√©m maior risco de vazamento de estado entre testes ‚Äî usar com cuidado.
```python
import pytest

@pytest.fixture(scope="session")
def session_context(browser):
    # abre um contexto que dura toda a sess√£o de testes
    ctx = browser.new_context()
    yield ctx
    ctx.close()

def test_session_1(session_context):
    p = session_context.new_page()
    p.goto("https://example.com/s1")
    assert "Example" in p.title()
    p.close()

def test_session_2(session_context):
    p = session_context.new_page()
    p.goto("https://example.com/s2")
    assert "Example" in p.title()
    p.close()
```

### Observa√ß√µes e recomenda√ß√µes r√°pidas
* Use `function` (padr√£o) para maior isolamento e testes confi√°veis.
* Use `class` ou `module` quando o setup for custoso e os testes puderem compartilhar estado com seguran√ßa.
* Use `session` ou `package` apenas quando a redu√ß√£o de tempo justificar o risco de vazamento de estado ‚Äî prefira criar/fechar p√°ginas (page.close()) entre testes.
* Ao reutilizar contextos/p√°ginas, sempre fechar p√°ginas abertas (`page.close()`) e testar se o estado compartilhado n√£o afeta assertivas.

## 18. üß© Pytest‚ÄëBDD ‚Äî exemplos r√°pidos

Abaixo h√° exemplos m√≠nimos de uso do pytest-bdd integrados com pytest-playwright: um arquivo feature (Gherkin), defini√ß√µes de passos (step definitions) em Python e uma nota sobre fixtures. Copie os arquivos para a estrutura do projeto indicada e adapte seletores/URLs ao seu sistema.

Breve execu√ß√£o: instale pytest-bdd e execute com `pip install pytest-bdd` e depois `pytest -k login` ou apenas `pytest`.

````gherkin
# filepath: features/login.feature
Feature: Login de usu√°rio

  Background:
    Given the application is running

  Scenario: Login com sucesso
    Given I open the login page
    When I submit valid credentials
    Then I should see the dashboard

  Scenario Outline: Falha de login
    Given I open the login page
    When I submit credentials "<user>" "<password>"
    Then I should see an error message

    Examples:
      | user    | password |
      | wrong   | wrong    |
      | locked  | secret   |
````

Defini√ß√µes de passos ‚Äî test_login.py
```python
import pytest
from playwright.sync_api import Page

@pytest.mark.playwright
@pytest.fixture(scope="feature")
def dado_aplicacao_em_execucao(page: Page):
    """Cen√°rio: A aplica√ß√£o est√° em execu√ß√£o"""
    # Supondo que o servidor da aplica√ß√£o esteja rodando localmente na porta 8000
    page.goto("http://localhost:8000")
    yield
    # Aqui voc√™ pode adicionar c√≥digo para rodar ap√≥s o teste, se necess√°rio

@pytest.mark.playwright
def test_login_com_sucesso(page: Page, dado_aplicacao_em_execucao):
    """Cen√°rio: Login com sucesso"""
    page.goto("http://localhost:8000/login")
    page.fill("input[name='username']", "usuario_valido")
    page.fill("input[name='password']", "senha_valida")
    page.click("button[type='submit']")
    page.wait_for_selector("text=Bem-vindo ao seu painel")
    assert page.url == "http://localhost:8000/dashboard"

@pytest.mark.playwright
def test_login_falha(page: Page, dado_aplicacao_em_execucao):
    """Cen√°rio: Falha de login"""
    page.goto("http://localhost:8000/login")
    page.fill("input[name='username']", "usuario_invalido")
    page.fill("input[name='password']", "senha_invalida")
    page.click("button[type='submit']")
    page.wait_for_selector("text=Credenciais inv√°lidas")
    assert page.url == "http://localhost:8000/login"
```

Nota sobre fixtures:

As fixtures do pytest-bdd (como `given`, `when`, `then`) s√£o usadas para definir o comportamento esperado da aplica√ß√£o em cada passo do cen√°rio. Elas s√£o automaticamente vinculadas aos testes baseados em suas marca√ß√µes (por exemplo, `@pytest.mark.playwright`).

## Refer√™ncias

- Documenta√ß√£o do projeto
  - README principal: [README.md](./README.md) ‚Äî vis√£o geral do reposit√≥rio e instru√ß√µes de uso.
  - Documenta√ß√£o interna: [docs/](./docs/) ‚Äî guias, padr√µes e exemplos internos (se existir).
  - Contribui√ß√£o: [CONTRIBUTING.md](./CONTRIBUTING.md) ‚Äî normas para commits, PRs e execu√ß√£o de testes no CI.
  - Arquivos de configura√ß√£o e fixtures: [conftest.py](./tests/conftest.py) ‚Äî exemplos de fixtures compartilhadas.

- Documenta√ß√£o oficial e plugins
  - Pytest: https://docs.pytest.org/
  - Playwright for Python: https://playwright.dev/python/
  - pytest-playwright (plugin): https://github.com/microsoft/playwright-pytest
  - pytest-mock: https://pytest-mock.readthedocs.io/
  - pytest-xdist (paraleliza√ß√£o): https://pypi.org/project/pytest-xdist/
  - pytest-cov (cobertura): https://pytest-cov.readthedocs.io/

- Comandos √∫teis / refer√™ncia r√°pida
  - Instalar navegadores Playwright: `playwright install` ‚Äî veja https://playwright.dev/docs/installation
  - Executar testes com m√∫ltiplos navegadores: `pytest --browser chromium --browser firefox --browser webkit`
  - Executar testes em paralelo: `pytest -n auto` (requires pytest-xdist)

## ‚úÖ Conclus√£o

Com o pytest, pytest-mock, pytest-cov, pytest-xdist e pytest-playwright, voc√™ tem uma su√≠te completa para:

*   Testes unit√°rios e de integra√ß√£o
*   Testes de interface automatizados
*   Mock de chamadas HTTP
*   Execu√ß√£o paralela e cobertura de c√≥digo
*   Manuten√ß√£o facilitada com fixtures organizadas

